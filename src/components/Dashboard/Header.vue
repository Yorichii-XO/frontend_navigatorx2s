<template>
  <nav
    class="relative flex flex-wrap items-center justify-between px-0 py-2 mx-6 transition-all ease-in shadow-none duration-250 rounded-2xl lg:flex-nowrap lg:justify-start"
    navbar-main navbar-scroll="false"
  >
    <div class="flex items-center justify-between w-full px-4 py-1 mx-auto flex-wrap-inherit">
      <nav>
        <div class="flex items-center justify-between w-full px-4 py-1 mx-auto flex-wrap-inherit">
      <nav>
        <div class="getting-started-hint bg-white rounded-lg w-[60%] " data-getting-started-step="track_time"
          data-gs-content="Track time to your projects and tasks"
          data-new-project-url="https://app.hubstaff.com/organizations/605805/projects/new.dialog?manager_id=2894429&amp;via_web_timer=true"
          data-placement="bottom" id="web-timer">
          <div class="web-timer-topbar">
            <a href="#" data-original-title="Open timer" class="">
              <svg width="36px" data-name="Layer 1" id="Layer_1" viewBox="0 0 512 512"
                xmlns="http://www.w3.org/2000/svg">
                <title />
                <path
                  d="M392,294.54h0a135.56,135.56,0,0,0-39.15-95.39,8.36,8.36,0,0,0-.68-.79,8.47,8.47,0,0,0-.8-.68A135.54,135.54,0,0,0,256,158.52h0a135.54,135.54,0,0,0-95.38,39.16,7.36,7.36,0,0,0-1.48,1.47A135.56,135.56,0,0,0,120,294.54h0a135.55,135.55,0,0,0,39.15,95.38,8.36,8.36,0,0,0,.68.79,8.59,8.59,0,0,0,.8.69A135.57,135.57,0,0,0,256,430.55h0a135.57,135.57,0,0,0,95.38-39.15,7.78,7.78,0,0,0,1.48-1.48A135.55,135.55,0,0,0,392,294.54Zm-29.25,8h13a119.5,119.5,0,0,1-29.45,71l-9.14-9.13a8,8,0,0,0-11.31,11.31l9.13,9.13a119.45,119.45,0,0,1-71,29.46v-13a8,8,0,1,0-16,0v13a119.57,119.57,0,0,1-71-29.46l9.13-9.13a8,8,0,1,0-11.31-11.32l-9.14,9.14a119.5,119.5,0,0,1-29.45-71h13a8,8,0,0,0,0-16h-13a119.53,119.53,0,0,1,29.45-71l9.14,9.14a8,8,0,0,0,11.31-11.31L177,204.25a119.5,119.5,0,0,1,71-29.45v13a8,8,0,0,0,16,0v-13a119.5,119.5,0,0,1,71,29.45l-9.13,9.14a8,8,0,0,0,11.31,11.31l9.14-9.14a119.53,119.53,0,0,1,29.45,71h-13a8,8,0,0,0,0,16Zm26.52-110.17,25.66-25.65a8,8,0,0,0,0-11.32l-19.8-19.8a8,8,0,0,0-11.32,0l-25.65,25.65A167.15,167.15,0,0,0,278,128V99.77h20.67a8,8,0,0,0,8-8V57.45a8,8,0,0,0-8-8H213.33a8,8,0,0,0-8,8V91.77a8,8,0,0,0,8,8H234V128a167.11,167.11,0,0,0-80.17,33.28L128.18,135.6a8,8,0,0,0-11.32,0l-19.8,19.8a8,8,0,0,0,0,11.32l25.66,25.65A167.14,167.14,0,0,0,88,294.54c0,92.64,75.37,168,168,168s168-75.37,168-168A167.14,167.14,0,0,0,389.28,192.37Zm.2-39.8,8.49,8.49L378.9,180.11q-4.08-4.38-8.48-8.48ZM221.33,65.45h69.34V83.77H221.33ZM250,99.77h12v26.87c-2-.07-4-.12-6-.12s-4,0-6,.12ZM114,161.06l8.49-8.49,19.06,19.06q-4.4,4.1-8.49,8.48ZM256,446.55c-83.82,0-152-68.19-152-152s68.19-152,152-152,152,68.2,152,152S339.82,446.55,256,446.55ZM291.83,319a8,8,0,0,1-11.32,11.31L250.34,300.2h0c-.18-.18-.36-.38-.53-.58l-.22-.3-.24-.33c-.08-.12-.15-.24-.22-.36a3.14,3.14,0,0,1-.18-.31,2.64,2.64,0,0,1-.18-.38c-.06-.11-.11-.22-.16-.33s-.09-.25-.14-.37-.09-.24-.12-.37-.07-.25-.1-.37-.07-.26-.09-.39,0-.3-.07-.45,0-.21-.05-.32a7,7,0,0,1,0-.79V216.82a8,8,0,0,1,16,0v74.4Z" />
              </svg> <span class="duration-timer topbar-tracked">0:00:00</span>
              <svg class="feather feather-arrow-up-right" fill="none" height="29px" stroke="currentColor"
                stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="24"
                xmlns="http://www.w3.org/2000/svg">
                <line x1="7" x2="17" y1="17" y2="7" />
                <polyline points="7 7 17 7 17 17" />
              </svg> </a>
          </div>

        </div></nav></div>
      </nav>
      <p class="ml-2 mt-4 text-sm text-gray-400 font-medium">Activity Monitoring and Time Tracking System.</p>

      <div class="flex items-center mt-2 grow sm:mt-0 sm:mr-6 md:mr-0 lg:flex lg:basis-auto">
        <div class="flex items-center md:ml-auto md:pr-4"></div>
        <ul class="flex flex-row justify-end mb-0 list-none md-max:w-full  space-x-4">
          <li class="flex items-center">
            <a
              href="#"
              @click.prevent="logout"
              class="block px-0 py-2 text-sm font-semibold text-white transition-all ease-nav-brand"
            >
            <i class="fa fa-user sm:mr-1"></i>
              <span class="ml-1">Logout</span>
            </a>
          </li>
          <li class="relative flex items-center pr-2 w-auto">
  <p class="hidden transform-dropdown-show"></p>

  <a
    href="#"
    @click.prevent="toggleDropdown"
    class="block p-0 w-auto text-sm text-white transition-all ease-nav-brand"
    dropdown-trigger aria-expanded="false"
  >
    <div class="relative">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="w-6 cursor-pointer text-white"
        fill="white"
        viewBox="0 0 371.263 371.263"
      >
        <path
          d="M305.402 234.794v-70.54c0-52.396-33.533-98.085-79.702-115.151.539-2.695.838-5.449.838-8.204C226.539 18.324 208.215 0 185.64 0s-40.899 18.324-40.899 40.899c0 2.695.299 5.389.778 7.964-15.868 5.629-30.539 14.551-43.054 26.647-23.593 22.755-36.587 53.354-36.587 86.169v73.115c0 2.575-2.096 4.731-4.731 4.731-22.096 0-40.959 16.647-42.995 37.845-1.138 11.797 2.755 23.533 10.719 32.276 7.904 8.683 19.222 13.713 31.018 13.713h72.217c2.994 26.887 25.869 47.905 53.534 47.905s50.54-21.018 53.534-47.905h72.217c11.797 0 23.114-5.03 31.018-13.713 7.904-8.743 11.797-20.479 10.719-32.276-2.036-21.198-20.958-37.845-42.995-37.845a4.704 4.704 0 0 1-4.731-4.731zM185.64 23.952c9.341 0 16.946 7.605 16.946 16.946 0 .778-.12 1.497-.24 2.275-4.072-.599-8.204-1.018-12.336-1.138-7.126-.24-14.132.24-21.078 1.198-.12-.778-.24-1.497-.24-2.275.002-9.401 7.607-17.006 16.948-17.006zm0 323.358c-14.431 0-26.527-10.3-29.342-23.952h58.683c-2.813 13.653-14.909 23.952-29.341 23.952zm143.655-67.665c.479 5.15-1.138 10.12-4.551 13.892-3.533 3.773-8.204 5.868-13.353 5.868H59.89c-5.15 0-9.82-2.096-13.294-5.868-3.473-3.772-5.09-8.743-4.611-13.892.838-9.042 9.282-16.168 19.162-16.168 15.809 0 28.683-12.874 28.683-28.683v-73.115c0-26.228 10.419-50.719 29.282-68.923 18.024-17.425 41.498-26.887 66.528-26.887 1.198 0 2.335 0 3.533.06 50.839 1.796 92.277 45.929 92.277 98.325v70.54c0 15.809 12.874 28.683 28.683 28.683 9.88 0 18.264 7.126 19.162 16.168z"
        />
      </svg>
      <span
        class="bg-red-500 text-[10px] px-1.5 font-semibold min-w-[16px] h-4 flex items-center justify-center text-white rounded-full absolute -top-2 left-[60%]"
      >
        {{ invitations.length }} <!-- Display the number of invitations -->
      </span>
    </div>
  </a>
  
  <div v-if="dropdownOpen" class="absolute right-0 z-10 w-auto h-auto bg-white rounded-md shadow-lg mt-60">
    <div class="py-2">
      <div v-if="invitations.length === 0" dropdown-menu class="text-sm w-auto 
          before:font-awesome before:leading-default before:duration-350 
          before:ease lg:shadow-3xl duration-250 min-w-44 
          before:sm:right-8 before:text-5.5 pointer-events-none 
          absolute right-0 top-0 z-50 origin-top list-none 
          rounded-lg border-0 border-solid border-transparent dark:shadow-dark-xl 
          dark:bg-slate-850 bg-white bg-clip-padding px-2 py-4 text-left 
          text-slate-500 opacity-0 transition-all 
          before:absolute before:right-2 before:left-auto 
          before:top-0 before:z-50 before:inline-block 
          before:font-normal before:text-white before:antialiased 
          before:transition-all before:content-['\f0d8']
          sm:-mr-6 lg:absolute lg:right-0 lg:left-auto lg:mt-2 lg:block lg:cursor-pointer">
        No new notifications
      </div>
      <template v-else>
        <div class="relative mb-2">
          <div
            v-for="invitation in invitations"
            :key="invitation.id"
            class="dark:hover:bg-slate-900 ease py-1.2 clear-both block w-auto whitespace-nowrap rounded-lg bg-transparent px-4 duration-300 hover:bg-gray-200 hover:text-slate-700 lg:transition-colors"
          >
            <div class="flex py-1 w-auto">
              <div class="my-auto flex items-center justify-center rounded-xl h-9 w-9 max-w-none bg-blue-500 text-white font-bold mr-2">
                {{ invitation.invited_by.charAt(0).toUpperCase() }} <!-- Avatar with first letter -->
              </div>
              <div class="flex flex-col justify-center">
                <h6 class="mb-1 text-sm font-normal leading-normal dark:text-white">
                  <span class="font-semibold">New message</span>
                  {{ invitation.invited_by }}
                </h6>
                <p class="mb-0 text-xs leading-tight text-slate-400 dark:text-white/80">
                  <i class="mr-1 fa fa-clock"></i>
                  {{ invitation.created_at }}
                </p>
              </div>
            </div>
            <span>
              <p class="text-sm">You have been invited to join!</p>
            </span>
            <div class="flex items-center">
              <button @click="acceptInvitation(invitation.id)" class="text-blue-600">Accept</button>
              <button @click="declineInvitation(invitation.id)" class="text-red-600 ml-2">Decline</button>
              <button @click="deleteNotification(invitation.id)" class="ml-2 text-red-600">
                <svg viewBox="0 0 24 24" fill="red" width="16px">
                  <path d="M3 6h18v2H3zm3 2h12v12H6z" />
                </svg>
              </button>
            </div>
          </div>
        </div>
      </template>
    </div>
  </div>
</li>


        </ul>
      </div>
    </div>
  </nav>
</template>

<script>
import axios from 'axios';

export default {
  data() {
    return {
      dropdownOpen: false,
      invitations: [], // This should be populated with your invitations
    };
  },
  methods: {
    toggleDropdown() {
      this.dropdownOpen = !this.dropdownOpen;
      if (this.dropdownOpen) {
        this.fetchInvitations();
      }
    },
    async fetchInvitations() {
      try {
        const token = localStorage.getItem('authToken'); // Retrieve token from local storage
        const response = await fetch('/api/invitations', {
          headers: {
            'Authorization': `Bearer ${token}`, // Include the token in the Authorization header
            'Content-Type': 'application/json',
          },
        });
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        const data = await response.json();
        this.invitations = data;
      } catch (error) {
        console.error('Error fetching invitations:', error);
      }
    },
    acceptInvitation(id) {
  if (!id) {
    console.error("Invitation ID is undefined.");
    return; // Exit if ID is undefined
  }

  const authToken = localStorage.getItem('authToken'); // Adjust to your token storage method
  const headers = {
    'Authorization': `Bearer ${authToken}`,
    'Content-Type': 'application/json'
  };

  // Example data to send in the request body
  const data = {
    role_id: 1, // Example role ID, adjust as necessary
    is_active: true // Assuming this needs to be sent
  };

  axios.post(`/invitations/${id}/accept`, data, { headers })
    .then((response) => {
      console.log(`Accepted invitation with ID: ${id}`);
      console.log(response.data.message); // Show success message
      // Optionally handle state updates or UI changes
    })
    .catch((error) => {
      if (error.response) {
        console.error("Error accepting invitation:", error.response.data); // Inspect the validation errors
      } else {
        console.error("Error accepting invitation:", error);
      }
    })},
  declineInvitation(id) {
    if (!id) {
      console.error("Invitation ID is undefined.");
      return; // Exit if ID is undefined
    }

    // Logic to decline an invitation
    this.$http
      .post(`/api/invitations/${id}/decline`)
      .then((response) => {
        console.log(`Declined invitation with ID: ${id}`);
        // Optionally remove the invitation from the list
        this.invitations = this.invitations.filter(inv => inv.id !== id);
      })
      .catch((error) => {
        console.error("Error declining invitation:", error);
      });
  },
    async deleteNotification(id) {
      try {
        const token = localStorage.getItem('authToken'); // Retrieve token from local storage
        await fetch(`/invitations/${id}/delete`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
          },
        });
        // Remove invitation from the list after deleting
        this.invitations = this.invitations.filter(invitation => invitation.id !== id);
      } catch (error) {
        console.error('Error deleting notification:', error);
      }
    },
    logout() {
    axios.post('/logout', {}, {
        headers: {
            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
        }
    })
    .then(() => {
        // Remove the token from local storage
        localStorage.removeItem('authToken');
        // Redirect to the login page
        this.$router.push('/login');
    })
    .catch(error => {
        if (error.response) {
            console.error('Logout error:', error.response.data);
        } else {
            console.error('Logout error:', error.message);
        }
    });
}

  },
};
</script>

<style scoped>
/* Add any additional styles here */
</style>
